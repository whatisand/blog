{"componentChunkName":"component---src-templates-post-jsx","path":"/mypy-clean-architecture-lsp/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Dongwoo"}},"markdownRemark":{"id":"5d662d33-711d-56f4-9161-a8cd1473ac32","excerpt":"들어가며 Fast API를 통해 개발중에 상속과 오버라이드를 해야 할 일이 있었습니다.\n린팅을 위해 mypy로 검사해보니 이런 오류를 내어 주었습니다. 단순히 메소드를 오버라이드 해서 생긴 문제라고 생각하기에는 다른 곳에서 동일한 방법으로 오버라이드한 메소드에서는 에러가 발생하지 않았습니다. 자세히 살펴보니 상속 과정에서 작동하는 오버라이드와 작동하지 않…","html":"<h2>들어가며</h2>\n<p>Fast API를 통해 개발중에 상속과 오버라이드를 해야 할 일이 있었습니다.\n린팅을 위해 mypy로 검사해보니 이런 오류를 내어 주었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Signature of \"create\" incompatible with supertype</code></pre></div>\n<p>단순히 메소드를 오버라이드 해서 생긴 문제라고 생각하기에는 다른 곳에서 동일한 방법으로 오버라이드한 메소드에서는 에러가 발생하지 않았습니다.</p>\n<p>자세히 살펴보니 상속 과정에서 작동하는 오버라이드와 작동하지 않는 오버라이드의 다른점이 있었습니다.\n작동하는 것은 슈퍼 클래스에서 정의한 인자의 형태를 그대로 사용하였으나, 작동하지 않는 것은 슈퍼 클래스에서 정의한 인자 이외의 하나를 추가하였습니다.</p>\n<p>왜 그럴까 궁금증이 생겨 문서를 찾아보게 되었습니다.</p>\n<h2>왜 에러가 나왔는가?</h2>\n<p>mypy 공식 문서에 보면 Liskov substitution principle에 위배되는 행위는 안된다고 합니다. 무엇인지 몰라 예시를 먼저 보았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Sequence<span class=\"token punctuation\">,</span> List<span class=\"token punctuation\">,</span> Iterable\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">:</span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">GeneralizedArgument</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># A more general argument type is okay</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">:</span> Iterable<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># OK</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">NarrowerArgument</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># A more specific argument type isn't accepted</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">:</span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Error</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">NarrowerReturn</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># A more specific return type is fine</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">:</span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># OK</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">GeneralizedReturn</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># A more general return type is an error</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">:</span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Iterable<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Error</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>예시를 보니 무언가 감이 잡혔습니다.</p>\n<ul>\n<li>인자로는, 부모 클래스에서 정의한 것보다 더 세부적인 것을 정의할 수 없다.</li>\n<li>반환값으로는, 부모 클래스에서 정의한 것 보다 더 제너럴하게 정의할 수 없다.</li>\n</ul>\n<p>아직 직관적으로 이해가 되지는 않았습니다. ‘부모에서는 추상적으로 설계하고 자식이 디테일하게 설계하는게 맞지 않나?’ 라는 생각이 들었습니다.</p>\n<h2>Liskov substitution principle</h2>\n<blockquote>\n<p>확장에 대해서는 열려 있어야 하고, 변경에 대해서는 닫혀 있어야 한다.</p>\n</blockquote>\n<p>클린 아키텍쳐에서 설명하는 주요 원칙중 하나입니다. 각 객체들을 사용하는 것은 개발자간의 약속입니다. 상속받은 객체들 역시 같은 메소드에서는 같은 역할을 해야 합니다.\n추상화된 부모 클래스의 제약조건을 따라 개발하면, 그것을 상속받아 구체화되어 구현된 것들을 그대로 사용할 수 있어야 합니다.</p>\n<p>맞는 예시인지는 모르겠습니다만, SQLAlchemy를 쓸때 어떤 db를 사용하는지에 따라 내부 로직은 변화가 있겠지만 실제로 사용하는 개발자 입장에서는 추상화된 조건에 맞추어 사용하기만 하면 되는 것과 유사합니다. SQLAlchemy 에서 새로운 db를 지원하게 되었다고 해서 사용법이 달라지지 않게 하기 위해서는 LSP가 지켜져야 합니다.</p>\n<h3>내 코드의 문제점</h3>\n<p>아래는 저의 문제가 되는 코드입니다.</p>\n<p>부모 클래스의 메소드 정의</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">:</span> Session<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> obj_in<span class=\"token punctuation\">:</span> CreateSchemaType<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> ModelType<span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>에러난 자식 클래스의 메소드 정의</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n <span class=\"token keyword\">def</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>\n        self<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">:</span> Session<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> obj_in<span class=\"token punctuation\">:</span> ScheduleBlockCreate<span class=\"token punctuation\">,</span> user_id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> ScheduleBlock<span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>저희 코드에서 예시를 보면, 유저를 생성할때 전달해야 하는 인자는 유저 dto인데, 타임테이블을 생성할때는 타임테이블의 dto에 더해 유저 아이디를 따로 전달해야 하는 형태로 구현되어있었습니다.</p>\n<p>이렇게 적고 다시 보니 제 코드가 이상하게 구현된 것이 맞습니다.</p>\n<p>개발 과정에서는 당연히 다른 객체를 생성하니까 메소드의 형태가 다를 수 있다고 생각한 모양입니다.\n하지만, 특정 모델을 db에 생성하는 로직에서 특정 dto만 받기로 추상화되어 약속되어 있었는데 갑자기 다른 것을 달라고 하면 해당 메소드를 이용하는 개발자들은 헷갈릴 것입니다. 지금이야 저 혼자 개발하고 있지만 나중에 저는 고통받을 것이 뻔합니다.</p>\n<p>이런 관점에서, 반환하는 값에 대해서도 제한을 둔 LSP 철학이 이해가 되었습니다. 원래 생성한 이후에는 db에서 생성된 값을 dto 형식대로 반환해주기로 약속되어 있었습니다. 그런데 어떤 엔티티 형식에서는 뜬금없이 다른 형태로 반환해준다면 개발자는 별도 로직을 구현해야 할 것입니다.</p>\n<h2>해결하기</h2>\n<p>공식 문서에서는 타입 보장이 크게 필요없다면  <code class=\"language-text\"># type: ignore[override]</code> 를 통해 에러를 없앨 수 있다고 힙니다.\n다만 LSP에 대해서 알게 되었으니 LSP를 지키도록 아키텍쳐를 변경하고자 고민했습니다.</p>\n<p>지금 코드의 문제는, timetable을 생성하기 위해 사용하는 dto 외의 다른 값을 받아야 한다는 것이였습니다.</p>\n<p><strong>해결방법 후보</strong></p>\n<ol>\n<li>슈퍼 클래스에서 사용하는 타입에 맞도록 데이터 타입 스키마를 수정하기</li>\n<li>메소드를 무리하게 상속받지 않고 새로 만들어 사용하기</li>\n</ol>\n<p>dto 형식을 수정하는 것이 옳다고 생각했습니다. Timetable을 생성하기 위해서는 user<em>id가 필요하니 Timetable을 생성하기 위한 dto에 user</em>id를 포함하면 메소드를 상속받지 않아도 됩니다.\n문제는, 제가 개발해야 하는 타임테이블 생성 api는 user_id를 body로 받지 않고 비즈니스 로직단에서 입력해야 한다는 점이였습니다. </p>\n<p>Fast API에서는 정의한 dto 스키마대로 api 명세와 문서를 자동으로 정의해줍니다. dto를 수정하면 API 명세가 바뀌기 떄문에 일단 메소드명을 수정하기로 했습니다. 결국 Api Endpoint를 개발하는 코드와 종속성이 생길 가능성이 생겼습니다. 클린 아키텍쳐를 지키기 위해 클린 아키텍쳐를 위반할 여지를 남겨두게 되었습니다.</p>\n<p>이렇게 개발하고 보니 전반적인 아키텍쳐가 잘못 설계된 점이 많다는 것을 느꼈습니다. 모를때는 편했는데 알게 되니 코드가 마음에 들지 않습니다. 처음부터 알았으면 좋았을텐데 구현에 집중하다보니 놓친 부분이였습니다.</p>\n<p>요즘 클린 아키텍쳐에 대한 필요성을 몸소 느끼고 있습니다. 전에 공부할때는 한번 쓱 훑고 넘겼는데 이제서야 머리에 쏙쏙 들어옵니다.</p>\n<p>모르는 것이 생겼다는 슬픔은 새롭게 알게되었다는 기쁨으로 넘기고 공부해야겠습니다.</p>\n<h2>참고자료</h2>\n<ul>\n<li><a href=\"https://mypy.readthedocs.io/en/stable/common_issues.html#incompatible-overrides\">Common issues and solutions — Mypy 0.931 documentation</a></li>\n<li><a href=\"https://stackoverflow.com/questions/56860/what-is-an-example-of-the-liskov-substitution-principle\">oop - What is an example of the Liskov Substitution Principle? - Stack Overflow</a></li>\n</ul>","frontmatter":{"title":"Python incompatible with supertype 에러와 LSP","date":"February 09, 2022","update":"February 09, 2022","tags":["아키텍쳐","mypy","fast api"],"series":"오늘의 개발일기"},"fields":{"slug":"/mypy-clean-architecture-lsp/","readingTime":{"minutes":9.395}}},"seriesList":{"edges":[{"node":{"id":"6f900c4b-1d29-53b4-97f7-53aaa1a15c5f","fields":{"slug":"/https-with-aws-elb/"},"frontmatter":{"title":"AWS EC2에 배포된 서버 HTTPS 통신 적용하기"}}},{"node":{"id":"0288c92c-c5f2-5df2-87ec-88b2fc6c827d","fields":{"slug":"/docker-ec2-CD-github-actions/"},"frontmatter":{"title":"Github Actions를 이용해 Docker CD 도전기"}}},{"node":{"id":"5d662d33-711d-56f4-9161-a8cd1473ac32","fields":{"slug":"/mypy-clean-architecture-lsp/"},"frontmatter":{"title":"Python incompatible with supertype 에러와 LSP"}}}]},"previous":{"fields":{"slug":"/docker-ec2-CD-github-actions/"},"frontmatter":{"title":"Github Actions를 이용해 Docker CD 도전기"}},"next":{"fields":{"slug":"/프로덕트-필수-질문/"},"frontmatter":{"title":"제품을 개발하는 조직에서 항상 가져가야 하는 질문"}}},"pageContext":{"id":"5d662d33-711d-56f4-9161-a8cd1473ac32","series":"오늘의 개발일기","previousPostId":"0288c92c-c5f2-5df2-87ec-88b2fc6c827d","nextPostId":"d0b55411-e0e5-5844-b2ee-4324a4bbd443"}},"staticQueryHashes":[]}