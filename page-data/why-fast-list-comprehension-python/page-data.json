{"componentChunkName":"component---src-templates-post-jsx","path":"/why-fast-list-comprehension-python/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Dongwoo"}},"markdownRemark":{"id":"6f4930cf-7f46-53b9-828e-8e5aa8ff6148","excerpt":"들어가며 보통 언어를 공부하면 쉽게 사용할 수 있도록 만들어진 문법일수록 실행시간에서 손해보는 경우가 많았습니다.\n리스트 컴프리헨션도 일종의 언어 수준의 편의기능으로 생각했기에 당연히 느릴 것이라고 생각했습니다. 언어의 편의기능을 사용하면 가독성과 개발속도에서 이점을 가져가고 속도에서 약간 손해를 보는 것이라고 생각하면 이해가 쉬웠습니다.\n그런데 자세히 …","html":"<h2>들어가며</h2>\n<p>보통 언어를 공부하면 쉽게 사용할 수 있도록 만들어진 문법일수록 실행시간에서 손해보는 경우가 많았습니다.\n리스트 컴프리헨션도 일종의 언어 수준의 편의기능으로 생각했기에 당연히 느릴 것이라고 생각했습니다. 언어의 편의기능을 사용하면 가독성과 개발속도에서 이점을 가져가고 속도에서 약간 손해를 보는 것이라고 생각하면 이해가 쉬웠습니다.\n그런데 자세히 알게 되니 충격적인 사실이 있었습니다. 리스트 컴프리헨션을 쓰는 이유는 속도측면도 있다는 사실을 알았습니다.\n왜 그럴까? 왜 그렇게 만들어졌을까? 궁금해서 찾아보았습니다.</p>\n<h2>접근 방법</h2>\n<p>많은 분들이 리스트 컴프리헨션을 설명해주셨지만 제 마음에 드는 설명이 없었습니다. 리스트 컴프리헨션이 더 빠르다는 것도 충분히 중급 이상의 지식으로 취급되다 보니 더욱 자세한 설명을 찾기는 쉽지 않았습니다.</p>\n<p>사실 이 글을 쓰기 무색하게도 이미 제가 접근하고 싶은 방법대로 똑같이 접근해주신 분이 계셨습니다. 욱재님께 감사드립니다.</p>\n<p>파이썬은 스크립트 언어이지만 실행하기 전에 자체 엔진에서 해석할 수 있는 바이너리 코드로 변환(컴파일)됩니다. 동작은 같지만 바이너리 코드 상에서 다를 수 있기 때문에 성능을 비교할 때 바이너리 코드를 확인하곤 합니다.</p>\n<p>파이썬에서는 아래 모듈을 통해 바이너리 코드를 쉽게 읽을 수 있는 형태로 볼 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">import</span> dis\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">hello_world</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world!\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dis<span class=\"token punctuation\">.</span>dis<span class=\"token punctuation\">(</span>hello_world<span class=\"token punctuation\">)</span>\n  <span class=\"token number\">2</span>           <span class=\"token number\">0</span> LOAD_GLOBAL              <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">print</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">2</span> LOAD_CONST               <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'hello world!'</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">4</span> CALL_FUNCTION            <span class=\"token number\">1</span>\n              <span class=\"token number\">6</span> POP_TOP\n              <span class=\"token number\">8</span> LOAD_CONST               <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n             <span class=\"token number\">10</span> RETURN_VALUE\n<span class=\"token operator\">>></span><span class=\"token operator\">></span></code></pre></div>\n<p>이 모듈을 활용하여 for loop로 작동할때와, 같은 동작을 list comprehension으로 구현했을때의 바이너리 코드를 분석하여 작동을 비교해보려고 합니다.</p>\n<p>모듈에서 나타난 바이트 코드는 <a href=\"https://docs.python.org/3.7/library/dis.html#opcode-LIST_APPEND\">dis — Disassembler for Python bytecode — Python 3.7.12 documentation</a> 에 있습니다.</p>\n<h2>작동 방식</h2>\n<h4>List append 를 사용할 때의 바이트 코드</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">import</span> dis\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">use_append</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>             result<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dis<span class=\"token punctuation\">.</span>dis<span class=\"token punctuation\">(</span>use_append<span class=\"token punctuation\">)</span>\n  <span class=\"token number\">2</span>           <span class=\"token number\">0</span> BUILD_LIST               <span class=\"token number\">0</span>\n              <span class=\"token number\">2</span> STORE_FAST               <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\n  <span class=\"token number\">3</span>           <span class=\"token number\">4</span> LOAD_GLOBAL              <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">6</span> LOAD_CONST               <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">8</span> CALL_FUNCTION            <span class=\"token number\">1</span>\n             <span class=\"token number\">10</span> GET_ITER\n        <span class=\"token operator\">>></span>   <span class=\"token number\">12</span> FOR_ITER                <span class=\"token number\">14</span> <span class=\"token punctuation\">(</span>to <span class=\"token number\">28</span><span class=\"token punctuation\">)</span>\n             <span class=\"token number\">14</span> STORE_FAST               <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n\n  <span class=\"token number\">4</span>          <span class=\"token number\">16</span> LOAD_FAST                <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n             <span class=\"token number\">18</span> LOAD_METHOD              <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>append<span class=\"token punctuation\">)</span>\n             <span class=\"token number\">20</span> LOAD_FAST                <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n             <span class=\"token number\">22</span> CALL_METHOD              <span class=\"token number\">1</span>\n             <span class=\"token number\">24</span> POP_TOP\n             <span class=\"token number\">26</span> JUMP_ABSOLUTE           <span class=\"token number\">12</span>\n\n  <span class=\"token number\">5</span>     <span class=\"token operator\">>></span>   <span class=\"token number\">28</span> LOAD_FAST                <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n             <span class=\"token number\">30</span> RETURN_VALUE</code></pre></div>\n<h4>List Comprehension 의 바이트 코드</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">use_compre</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>i <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dis<span class=\"token punctuation\">.</span>dis<span class=\"token punctuation\">(</span>use_compre<span class=\"token punctuation\">)</span>\n  <span class=\"token number\">2</span>           <span class=\"token number\">0</span> LOAD_CONST               <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>code <span class=\"token builtin\">object</span> <span class=\"token operator\">&lt;</span>listcomp<span class=\"token operator\">></span> at <span class=\"token number\">0x7fe36818f870</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span> <span class=\"token string\">\"&lt;stdin>\"</span><span class=\"token punctuation\">,</span> line <span class=\"token number\">2</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">2</span> LOAD_CONST               <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'use_compre.&lt;locals>.&lt;listcomp>'</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">4</span> MAKE_FUNCTION            <span class=\"token number\">0</span>\n              <span class=\"token number\">6</span> LOAD_GLOBAL              <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">8</span> LOAD_CONST               <span class=\"token number\">3</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>\n             <span class=\"token number\">10</span> CALL_FUNCTION            <span class=\"token number\">1</span>\n             <span class=\"token number\">12</span> GET_ITER\n             <span class=\"token number\">14</span> CALL_FUNCTION            <span class=\"token number\">1</span>\n             <span class=\"token number\">16</span> RETURN_VALUE\n\nDisassembly of <span class=\"token operator\">&lt;</span>code <span class=\"token builtin\">object</span> <span class=\"token operator\">&lt;</span>listcomp<span class=\"token operator\">></span> at <span class=\"token number\">0x7fe36818f870</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span> <span class=\"token string\">\"&lt;stdin>\"</span><span class=\"token punctuation\">,</span> line <span class=\"token number\">2</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span>\n  <span class=\"token number\">2</span>           <span class=\"token number\">0</span> BUILD_LIST               <span class=\"token number\">0</span>\n              <span class=\"token number\">2</span> LOAD_FAST                <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">>></span>    <span class=\"token number\">4</span> FOR_ITER                 <span class=\"token number\">8</span> <span class=\"token punctuation\">(</span>to <span class=\"token number\">14</span><span class=\"token punctuation\">)</span>\n              <span class=\"token number\">6</span> STORE_FAST               <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n              <span class=\"token number\">8</span> LOAD_FAST                <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n             <span class=\"token number\">10</span> LIST_APPEND              <span class=\"token number\">2</span>\n             <span class=\"token number\">12</span> JUMP_ABSOLUTE            <span class=\"token number\">4</span>\n        <span class=\"token operator\">>></span>   <span class=\"token number\">14</span> RETURN_VALUE</code></pre></div>\n<p>두 코드의 차이점을 보겠습니다.</p>\n<p>리스트 컴프리헨션을 사용할 때의 코드를 보면 두 부분으로 나누어져 있는 것을 확인할 수 있습니다. MAKE_FUNCTION을 보니 자체적으로 함수를 만들어서 실행하는 것 같습니다. <listcomp>라고 하는 오브젝트가 있습니다.</p>\n<p>우리는 for loop를 이용한 것과 list comprehension을 이용한 것을 비교하고는 합니다. 루프에서 어떤 차이가 있는지 보겠습니다.</p>\n<p>for loop를 이용한 함수에서는 12번 부터 26번 전까지 loop를 수행합니다.\nlist comprehension 에서는 <listcomp> 아래 4번부터 12번까지 loop를 수행합니다.</p>\n<p>for loop 에서는 append method를 call 하고, lists comprehension에서는 LIST_APPEND 바이트 코드를 사용하여 append를 하는 것으로 추측됩니다.</p>\n<p><code class=\"language-text\">LIST_APPEND</code> 를 사용하는 것과 append를 <code class=\"language-text\">CALL_METHOD</code>로 불러오는 것의 차이때문으로 추측해볼 수 있는데, 실제로 문서에 따르면 LIST_APPEND에서 불러오는 코드와 list append에서 불러오는 함수는 동일한 함수를 불러오고 있습니다.</p>\n<p>결국 두 방식 모두 append하는 부분에서는 차이가 없습니다.</p>\n<h2>실제로 차이가 나는 부분은?</h2>\n<p>list append 방식에서는 <code class=\"language-text\">CALL_METHOD</code>를 통해 append 메소드를 사용합니다.\n그렇다면 <code class=\"language-text\">CALL_METHOD</code> 로직을 타면서 생기는 비효율이 있지 않을까 생각해볼 수 있습니다.</p>\n<p>욱재님의 블로그에서 빈 함수를 불러오는 for loop와 아무 것도 실행되지 않는 for loop를 도는 시간차이를 비교해 두었습니다. 저도 한번 해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span> python3 <span class=\"token operator\">-</span>m timeit <span class=\"token operator\">-</span>s <span class=\"token string\">\"def empty(): pass\"</span> <span class=\"token string\">\"for i in range(10000000): empty()\"</span>\n<span class=\"token number\">1</span> loop<span class=\"token punctuation\">,</span> best of <span class=\"token number\">5</span><span class=\"token punctuation\">:</span> <span class=\"token number\">665</span> msec per loop\n\n<span class=\"token operator\">%</span> python3 <span class=\"token operator\">-</span>m timeit <span class=\"token string\">\"for i in range(10000000): pass\"</span>\n<span class=\"token number\">2</span> loops<span class=\"token punctuation\">,</span> best of <span class=\"token number\">5</span><span class=\"token punctuation\">:</span> <span class=\"token number\">189</span> msec per loop</code></pre></div>\n<p>진짜로 엄청난 시간 차이가 발생합니다.</p>\n<p>list append 메소드를 사용하는 것과, list comprehension에서 자체적으로 append를 하는 것은 파이썬이 특정 메소드를 불러올 때 생기는 오버해드에서 생겨난 것이라고 할 수 있습니다.</p>\n<h2>참고자료</h2>\n<ul>\n<li><a href=\"https://jeongukjae.github.io/posts/inspecting-list-comprehension/\">🐍 List Comprehension이 빠른 이유를 찾아보자 – Ukjae Jeong</a></li>\n</ul>","frontmatter":{"title":"파이썬에서 List Comprehension이 더 빠른 이유","date":"February 27, 2022","update":"February 27, 2022","tags":["python"],"series":"오늘의 개발일기"},"fields":{"slug":"/why-fast-list-comprehension-python/","readingTime":{"minutes":7.025}}},"seriesList":{"edges":[{"node":{"id":"6f900c4b-1d29-53b4-97f7-53aaa1a15c5f","fields":{"slug":"/https-with-aws-elb/"},"frontmatter":{"title":"AWS EC2에 배포된 서버 HTTPS 통신 적용하기"}}},{"node":{"id":"0288c92c-c5f2-5df2-87ec-88b2fc6c827d","fields":{"slug":"/docker-ec2-CD-github-actions/"},"frontmatter":{"title":"Github Actions를 이용해 Docker CD 도전기"}}},{"node":{"id":"5d662d33-711d-56f4-9161-a8cd1473ac32","fields":{"slug":"/mypy-clean-architecture-lsp/"},"frontmatter":{"title":"Python incompatible with supertype 에러와 LSP"}}},{"node":{"id":"d0e53c35-f4b3-5089-b107-5d88a2e755ca","fields":{"slug":"/python-asterisk/"},"frontmatter":{"title":"파이썬 class(**external_data)이 뭘까?"}}},{"node":{"id":"1800b430-a402-58fe-be47-f0ae1a85ac8f","fields":{"slug":"/python-ellipsis/"},"frontmatter":{"title":"파이썬 “…” 표현식이 이 뭘까?"}}},{"node":{"id":"4e33266e-a547-50dd-82f9-f11b06633248","fields":{"slug":"/tcp-4way-handshake/"},"frontmatter":{"title":"TCP에서 연결 종료시 4-way Handshake가 필요한 이유"}}},{"node":{"id":"34cb1bf5-ad87-56df-acc3-c4cb4b3e04a1","fields":{"slug":"/python-staticmethod-classmethod/"},"frontmatter":{"title":"Python @staticmethod @classmethod 왜 사용할까?"}}},{"node":{"id":"6f4930cf-7f46-53b9-828e-8e5aa8ff6148","fields":{"slug":"/why-fast-list-comprehension-python/"},"frontmatter":{"title":"파이썬에서 List Comprehension이 더 빠른 이유"}}}]},"previous":{"fields":{"slug":"/python-staticmethod-classmethod/"},"frontmatter":{"title":"Python @staticmethod @classmethod 왜 사용할까?"}},"next":{"fields":{"slug":"/개발자의-역할/"},"frontmatter":{"title":"개발자에게 일이란 무엇인가?"}}},"pageContext":{"id":"6f4930cf-7f46-53b9-828e-8e5aa8ff6148","series":"오늘의 개발일기","previousPostId":"34cb1bf5-ad87-56df-acc3-c4cb4b3e04a1","nextPostId":"7b069fc0-5b34-56ae-a418-b1cbbc12580d"}},"staticQueryHashes":[]}